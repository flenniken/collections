"use strict";let imageIx=null,availWidth=null,availHeight=null,area=null;window.addEventListener("load",handleLoad),window.addEventListener("touchstart",handleTouchStart),window.addEventListener("restoreimage",handleRestoreImage,!1),window.addEventListener("touchmove",handleTouchMove,{passive:!1}),window.addEventListener("resize",handleResize),document.addEventListener("touchend",handleTouchEnd,!1),document.addEventListener("touchcancel",handleTouchCancel,!1),screen.orientation.addEventListener("change",handleChange);class Timer{constructor(){this.start=performance.now()}seconds(){return(performance.now()-this.start)/1e3}log(t){log(three(this.seconds())+"s ----- "+t)}}const startTimer=new Timer;function get(t){return document.getElementById(t)}function log(t){console.log(t)}function logError(t){console.error(t)}function two(t){return t.toFixed(2)}function three(t){return t.toFixed(3)}async function handleLoad(){startTimer.log(`load event; the collection contains ${cJson.images.length} images`),area=get("area"),get("images").setAttribute("touch-action","none"),setFirstImage(),startTimer.log("setAvailableArea"),setAvailableArea(),startTimer.log("sizeImages"),sizeImages(),document.body.style.visibility="visible",document.body.style.opacity=1,startTimer.log("load Done")}function setFirstImage(){log("window.location.search: "+window.location.search);var t=new URLSearchParams(window.location.search).get("image"),t=(log("Image query string: "+t),parseInt(t,10));log("First image: "+((imageIx=!isNaN(t)&&1<=t&&t<=cJson.images.length?t-1:0)+1))}function setAvailableArea(){var t=document.documentElement.clientWidth;let e=document.documentElement.clientHeight;return e>t&&window.matchMedia("(display-mode: standalone)").matches&&(e+=60,log("Add 60 to height for the top bar.")),t==availWidth&&e==availHeight?(log(`Available size is the same: ${availWidth} x `+availHeight),!1):(availWidth=t,availHeight=e,zpan.minVisible=availWidth/4,area.style.width=availWidth+"px",log(`Available screen size: ${availWidth} x `+availHeight),!0)}function getZoomPoint(t=cJson){var e=availWidth+"x"+availHeight;return t.zoomPoints[e][imageIx]}function sizeImages(){let o=0;var t=availWidth+"x"+availHeight;let n;const r=!(t in cJson.zoomPoints);r?(log("No zoom points for this size, create new zoom points."),log("Existing zoom points: "+Object.keys(cJson.zoomPoints)),n=[],cJson.zoomPoints[t]=n):n=cJson.zoomPoints[t],hscroll.leftEdges.length=0,log("Image zoom points:"),cJson.images.forEach((t,e)=>{(t.width<availWidth||t.height<availHeight)&&logError("small images are not supported"),hscroll.leftEdges.push(o);get("cb"+(e+1)).style.width=availWidth+"px";var l=get("c"+(e+1));l.style.width=availWidth+"px",l.style.height=availHeight+"px";let a;r?(a={},t.width-availWidth>t.height-availHeight?a.scale=availWidth/t.width:a.scale=availHeight/t.height,a.tx=0,a.ty=0,n.push(a)):a=n[e];l=get("i"+(e+1));l.style.width=a.width+"px",l.style.height=a.height+"px",l.style.transformOrigin="0px 0px",l.style.transform=`translate(${a.tx}px, ${a.ty}px) scale(${a.scale})`,log(`i${e+1}: ${availWidth} x ${availHeight}, `+`scale: ${two(a.scale)}, `+`t: (${two(a.tx)}, ${two(a.ty)})`),o+=availWidth}),area.scrollLeft=hscroll.leftEdges[imageIx],log("area.scrollLeft: "+area.scrollLeft),log("hscroll.leftEdges: "+hscroll.leftEdges)}let zpan={minVisible:null,zooming:!1,start:{},current:{}},doubleClick=null,hscroll={minFlick:1,framesPerSec:30,maxDuration:1.5,scrolling:!1,leftEdges:[],startX:null,startY:null,currentX:null,startXTime:null,currentXTime:null,startScrollLeft:null,currentScrollLeft:0};function handleTouchStart(t){if(!hscroll.scrolling){if(hscroll.startScrollLeft=area.scrollLeft,hscroll.currentX=hscroll.startX=t.touches[0].clientX,hscroll.currentXTime=hscroll.startXTime=performance.now(),hscroll.startY=t.touches[0].clientY,log(`touchstart: scroll image: ${imageIx+1}, hscroll.startScrollLeft: `+hscroll.startScrollLeft),1==t.touches.length){if(null!==doubleClick)if(doubleClick.seconds()<.5){const t=new Event("restoreimage");return window.dispatchEvent(t),void(doubleClick=null)}doubleClick=new Timer}else doubleClick=null;var e,l,a;2==t.touches.length&&(zpan.zooming=!0,t.preventDefault(),a=t.touches[0].clientX,e=t.touches[1].clientX,l=t.touches[0].clientY,t=t.touches[1].clientY,zpan.start.cx=(a+e)/2,zpan.start.cy=(l+t)/2,zpan.start.distance=Math.hypot(a-e,l-t),a=getZoomPoint(),zpan.start.scale=a.scale,zpan.start.tx=a.tx,zpan.start.ty=a.ty,cJson.images[imageIx],log(`i${imageIx+1}: touchstart: c: (${two(zpan.start.cx)}, ${two(zpan.start.cy)}) `+`d: ${two(zpan.start.distance)}, scale: ${two(zpan.start.scale)}, `+`t: (${two(zpan.start.tx)}, ${two(zpan.start.ty)})`))}}function handleRestoreImage(t){log("Restore image to its zoom point.");cJson.images[imageIx];let e=getZoomPoint(cJson);const l=getZoomPoint(cJsonOriginal),a=(log(`Zoom point: (${two(e.tx)}, ${two(e.ty)}), scale: `+two(e.scale)),log(`Original zoom point: (${two(l.tx)}, ${two(l.ty)}), scale: `+two(l.scale)),get("i"+(imageIx+1)));a.animate([{transform:`translate(${e.tx}px, ${e.ty}px) scale(${e.scale})`},{transform:`translate(${l.tx}px, ${l.ty}px) scale(${l.scale})`}],{duration:300,iterations:1}).onfinish=t=>{log("Restore image finished"),e.scale=l.scale,e.tx=l.tx,e.ty=l.ty,a.style.transform=`translate(${e.tx}px, ${e.ty}px) scale(${e.scale})`}}function handleTouchMove(o){if(hscroll.scrolling)horizontalScrollMove(o);else{if(!zpan.zooming){var n=Math.abs(hscroll.startX-o.touches[0].clientX);if(Math.abs(hscroll.startY-o.touches[0].clientY)<n)return hscroll.scrolling=!0,doubleClick=null,void horizontalScrollMove(o)}if(2==o.touches.length&&(o.preventDefault(),zpan.zooming)){var n=o.touches[0].clientX,r=o.touches[1].clientX,i=o.touches[0].clientY,o=o.touches[1].clientY,s=cJson.images[imageIx],c=getZoomPoint();zpan.current.cx=(n+r)/2,zpan.current.cy=(i+o)/2,zpan.current.distance=Math.hypot(n-r,i-o),zpan.current.scale=zpan.current.distance/zpan.start.distance*zpan.start.scale,1<zpan.current.scale&&(zpan.current.scale=1);let t=s.width*zpan.current.scale,e=s.height*zpan.current.scale;t<availWidth/2&&(zpan.current.scale=availWidth/2/s.width,t=s.width*zpan.current.scale,e=s.height*zpan.current.scale);n={};n.cx=(zpan.start.cx-zpan.start.tx)*zpan.current.scale/zpan.start.scale+zpan.start.tx,n.cy=(zpan.start.cy-zpan.start.ty)*zpan.current.scale/zpan.start.scale+zpan.start.ty;let l=zpan.start.tx-(n.cx-zpan.start.cx)+(zpan.current.cx-zpan.start.cx),a=zpan.start.ty-(n.cy-zpan.start.cy)+(zpan.current.cy-zpan.start.cy);l>availWidth-zpan.minVisible&&(l=availWidth-zpan.minVisible),a>availHeight-zpan.minVisible&&(a=availHeight-zpan.minVisible);l+t<zpan.minVisible&&(l=zpan.minVisible-t);r=a+e;r<zpan.minVisible&&(a=zpan.minVisible-e),c.scale=zpan.current.scale,c.tx=l,c.ty=a,get("i"+(imageIx+1)).style.transform=`translate(${c.tx}px, ${c.ty}px) scale(${c.scale})`}}}function handleTouchCancel(t){log("touchcancel"),handleTouchEnd(t)}function handleTouchEnd(t){log("touchend"),0==t.touches.length&&hscroll.scrolling?horizontalScrollEnd():zpan.zooming&&(zpan.zooming=!1,cJson.images[imageIx],t=getZoomPoint(),log(`i${imageIx+1}: touchend: c: (${two(zpan.current.cx)}, ${two(zpan.current.cy)}) `+`d: ${two(zpan.current.distance)}, scale: ${two(t.scale)}, `+`t: (${two(t.tx)}, ${two(t.ty)})`))}function logJson(){log(JSON.stringify(cJson,null,2))}function horizontalScrollMove(t){t.preventDefault(),hscroll.currentXTime=performance.now(),hscroll.currentX=t.touches[0].clientX,hscroll.currentScrollLeft=hscroll.startScrollLeft+hscroll.startX-hscroll.currentX,area.scrollLeft=hscroll.currentScrollLeft}function horizontalScrollEnd(){var e=hscroll.currentXTime-hscroll.startXTime,l=hscroll.currentX-hscroll.startX,a=l/e,e=(log(`ScrollEnd: pps: ${two(a)}, dx: ${l}, hDuration: ${three(e/1e3)}s`),log("ScrollEnd: hscroll.currentScrollLeft: "+two(hscroll.currentScrollLeft)),log(`ScrollEnd: hscroll.currentX: ${hscroll.currentX}, hscroll.startX: ${hscroll.startX},  `+`hscroll.currentXTime: ${Math.floor(hscroll.currentXTime)}, `+"hscroll.startXTime: "+Math.floor(hscroll.startXTime)),Math.abs(a)>hscroll.minFlick);let t;t=e?(log("Flick the image."),0<l?-availWidth:availWidth):hscroll.currentScrollLeft>hscroll.startScrollLeft+availWidth/2?availWidth:hscroll.currentScrollLeft<hscroll.startScrollLeft-availWidth/2?-availWidth:0;a=hscroll.currentScrollLeft,e=hscroll.startScrollLeft+t;if(area.scrollLeft==e)n();else{log(`ScrollEnd: animate from ${two(a)} to `+e);var l=availWidth/2,o=hscroll.maxDuration*hscroll.framesPerSec,o=Math.abs(e-a)*o/l;let t=0;const r=distanceList(a,e,o);l=o/hscroll.framesPerSec;log(`ScrollEnd: number of frames: ${r.length}, duration: ${two(l)} seconds`);const i=setInterval(function(){t>=r.length?(clearInterval(i),n()):(area.scrollLeft=r[t],t+=1)},l/1e3);function n(){var t=hscroll.leftEdges.indexOf(area.scrollLeft);-1==t?logError(`area.scrollLeft ${area.scrollLeft} was not found.`):imageIx==t?log(`ScrollEnd: scrolled back to the original item ${imageIx+1}.`):(imageIx=t,log(`ScrollEnd: scroll done: area.scrollLeft: ${area.scrollLeft}, image: `+(imageIx+1))),hscroll.scrolling=!1}}}function distanceList(e,t,l){var a=[],o=t-e;if(1<l&&1<Math.abs(o)){var n=o/l;for(let t=1;t<l-1;t++)a.push(Math.round(e+n*t))}return a.push(t),a}function handleChange(t){log(`change: ${t.target.type}, ${t.target.angle} degrees.`)}function handleResize(){var t=new Timer,e=(t.log("resize"),setAvailableArea());e&&(t.log("sizeImages"),sizeImages()),t.log("resize  done")}