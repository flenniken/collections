"use strict";var CJson,cJson,cJsonOriginal,__awaiter=this&&this.__awaiter||function(t,r,i,s){return new(i=i||Promise)(function(l,e){function a(t){try{n(s.next(t))}catch(t){e(t)}}function o(t){try{n(s.throw(t))}catch(t){e(t)}}function n(t){var e;t.done?l(t.value):((e=t.value)instanceof i?e:new i(function(t){t(e)})).then(a,o)}n((s=s.apply(t,r||[])).next())})};!function(t){t.Image=class{};t.Collection=class{}}(CJson=CJson||{});let imageIx=0,availWidth=0,availHeight=0,area=null,vOverScrolling=!1;window.addEventListener("load",handleLoad),window.addEventListener("touchstart",handleTouchStart),window.addEventListener("restoreimage",handleRestoreImage,!1),window.addEventListener("touchmove",handleTouchMove,{passive:!1}),window.addEventListener("resize",handleResize),document.addEventListener("touchend",handleTouchEnd,!1),document.addEventListener("touchcancel",handleTouchCancel,!1);class Timer{constructor(){this.start=performance.now()}seconds(){return(performance.now()-this.start)/1e3}log(t){log(three(this.seconds())+"s ----- "+t)}}const startTimer=new Timer;function get(t){return document.getElementById(t)}function log(t){console.log(t)}function logError(t){console.error(t)}function two(t){return t.toFixed(2)}function three(t){return t.toFixed(3)}function handleLoad(){return __awaiter(this,void 0,void 0,function*(){startTimer.log(`load event; the collection contains ${cJson.images.length} images`),area=get("area"),get("images").setAttribute("touch-action","none"),setFirstImage(),startTimer.log("setAvailableArea"),setAvailableArea(),startTimer.log("sizeImages"),sizeImages(),document.body.style.visibility="visible",document.body.style.opacity="1",startTimer.log("load Done")})}function setFirstImage(){log("window.location.search: "+window.location.search);var t=new URLSearchParams(window.location.search).get("image"),t=(log("Image query string: "+t),parseInt(t,10));log("First image: "+((imageIx=!isNaN(t)&&1<=t&&t<=cJson.images.length?t-1:0)+1))}function setAvailableArea(){var t=document.documentElement.clientWidth;let e=document.documentElement.clientHeight;return e>t&&window.matchMedia("(display-mode: standalone)").matches&&(e+=60,log("Add 60 to height for the top bar.")),t==availWidth&&e==availHeight?(log(`Available size is the same: ${availWidth} x `+availHeight),!1):(availWidth=t,availHeight=e,zpan.minVisible=availWidth/4,area.style.width=availWidth+"px",log(`Available screen size: ${availWidth} x `+availHeight),!0)}function getZoomPoint(t=cJson){var e=availWidth+"x"+availHeight;return t.zoomPoints[e][imageIx]}function sizeImages(){let o=0;var t=availWidth+"x"+availHeight;let n;const r=!(t in cJson.zoomPoints);r?(log("No zoom points for this size, create new zoom points."),log("Existing zoom points: "+Object.keys(cJson.zoomPoints)),n=[],cJson.zoomPoints[t]=n):n=cJson.zoomPoints[t],hscroll.leftEdges.length=0,log("Image zoom points:"),cJson.images.forEach((e,t)=>{(e.width<availWidth||e.height<availHeight)&&logError("small images are not supported"),hscroll.leftEdges.push(o);get("cb"+(t+1)).style.width=availWidth+"px";var l=get("c"+(t+1));l.style.width=availWidth+"px",l.style.height=availHeight+"px";let a;if(r){let t;t=e.width-availWidth>e.height-availHeight?availWidth/e.width:availHeight/e.height,a={scale:t,tx:0,ty:0},n.push(a)}else a=n[t];l=get("i"+(t+1));l.style.transformOrigin="0px 0px",l.style.transform=`translate(${a.tx}px, ${a.ty}px) scale(${a.scale})`,log(`i${t+1}: ${availWidth} x ${availHeight}, `+`scale: ${two(a.scale)}, `+`t: (${two(a.tx)}, ${two(a.ty)})`),o+=availWidth}),area.scrollLeft=hscroll.leftEdges[imageIx],log("area.scrollLeft: "+area.scrollLeft),log("hscroll.leftEdges: "+hscroll.leftEdges)}let zpan={minVisible:10,zooming:!1,start:null,current:null},doubleClick=null,hscroll={minFlick:1,framesPerSec:30,maxDuration:1.5,scrolling:!1,leftEdges:[],startX:null,startY:null,currentX:null,startXTime:null,currentXTime:null,startScrollLeft:null,currentScrollLeft:0};function handleTouchStart(t){if(hscroll.scrolling)t.preventDefault();else{if(hscroll.startScrollLeft=area.scrollLeft,hscroll.currentX=hscroll.startX=t.touches[0].clientX,hscroll.currentXTime=hscroll.startXTime=performance.now(),hscroll.startY=t.touches[0].clientY,log(`touchstart: scroll image: ${imageIx+1}, hscroll.startScrollLeft: `+hscroll.startScrollLeft),1==t.touches.length){if(null!==doubleClick)if(doubleClick.seconds()<.5){const t=new Event("restoreimage");return window.dispatchEvent(t),void(doubleClick=null)}doubleClick=new Timer}else doubleClick=null;var e,l,a;2==t.touches.length&&(zpan.zooming=!0,t.preventDefault(),a=t.touches[0].clientX,e=t.touches[1].clientX,l=t.touches[0].clientY,t=t.touches[1].clientY,zpan.start.cx=(a+e)/2,zpan.start.cy=(l+t)/2,zpan.start.distance=Math.hypot(a-e,l-t),a=getZoomPoint(),zpan.start.scale=a.scale,zpan.start.tx=a.tx,zpan.start.ty=a.ty,cJson.images[imageIx],log(`i${imageIx+1}: touchstart: c: (${two(zpan.start.cx)}, ${two(zpan.start.cy)}) `+`d: ${two(zpan.start.distance)}, scale: ${two(zpan.start.scale)}, `+`t: (${two(zpan.start.tx)}, ${two(zpan.start.ty)})`))}}function handleRestoreImage(t){log("Restore image to its zoom point.");cJson.images[imageIx];let e=getZoomPoint(cJson);const l=getZoomPoint(cJsonOriginal),a=(log(`Zoom point: (${two(e.tx)}, ${two(e.ty)}), scale: `+two(e.scale)),log(`Original zoom point: (${two(l.tx)}, ${two(l.ty)}), scale: `+two(l.scale)),get("i"+(imageIx+1)));a.animate([{transform:`translate(${e.tx}px, ${e.ty}px) scale(${e.scale})`},{transform:`translate(${l.tx}px, ${l.ty}px) scale(${l.scale})`}],{duration:300,iterations:1}).onfinish=t=>{log("Restore image finished"),e.scale=l.scale,e.tx=l.tx,e.ty=l.ty,a.style.transform=`translate(${e.tx}px, ${e.ty}px) scale(${e.scale})`}}function handleTouchMove(o){if(hscroll.scrolling)horizontalScrollMove(o);else{if(!zpan.zooming&&!vOverScrolling){var n=Math.abs(hscroll.startX-o.touches[0].clientX);if(Math.abs(hscroll.startY-o.touches[0].clientY)<n)return hscroll.scrolling=!0,doubleClick=null,void horizontalScrollMove(o)}if(hscroll.scrolling||1!=o.touches.length){if(o.preventDefault(),zpan.zooming){var n=o.touches[0].clientX,r=o.touches[1].clientX,i=o.touches[0].clientY,s=o.touches[1].clientY,c=cJson.images[imageIx],h=getZoomPoint();zpan.current.cx=(n+r)/2,zpan.current.cy=(i+s)/2,zpan.current.distance=Math.hypot(n-r,i-s),zpan.current.scale=zpan.current.distance/zpan.start.distance*zpan.start.scale,1<zpan.current.scale&&(zpan.current.scale=1);let t=c.width*zpan.current.scale,e=c.height*zpan.current.scale;t<availWidth/2&&(zpan.current.scale=availWidth/2/c.width,t=c.width*zpan.current.scale,e=c.height*zpan.current.scale);n=(zpan.start.cx-zpan.start.tx)*zpan.current.scale/zpan.start.scale+zpan.start.tx,r=(zpan.start.cy-zpan.start.ty)*zpan.current.scale/zpan.start.scale+zpan.start.ty;let l=zpan.start.tx-(n-zpan.start.cx)+(zpan.current.cx-zpan.start.cx),a=zpan.start.ty-(r-zpan.start.cy)+(zpan.current.cy-zpan.start.cy);l>availWidth-zpan.minVisible&&(l=availWidth-zpan.minVisible),a>availHeight-zpan.minVisible&&(a=availHeight-zpan.minVisible);l+t<zpan.minVisible&&(l=zpan.minVisible-t);i=a+e;i<zpan.minVisible&&(a=zpan.minVisible-e),h.scale=zpan.current.scale,h.tx=l,h.ty=a,get("i"+(imageIx+1)).style.transform=`translate(${h.tx}px, ${h.ty}px) scale(${h.scale})`}}else 0<(s=o.touches[0].clientY-hscroll.startY)&&0===window.scrollY&&(vOverScrolling||(vOverScrolling=!0,log("vOverScrolling started: hscroll.startY: "+hscroll.startY)),get("to-thumbnails").style.height=s+"px")}}function handleTouchCancel(t){log("touchcancel"),handleTouchEnd(t)}function handleTouchEnd(t){const e=get("to-thumbnails");var l;vOverScrolling&&animatePosition(l=parseInt(e.style.height,10),0,hscroll.framesPerSec,l,hscroll.maxDuration,function(){log("overScrolling done: tot.style.height: "+e.style.height),vOverScrolling=!1},t=>{e.style.height=t+"px"}),0==t.touches.length&&hscroll.scrolling?horizontalScrollEnd():zpan.zooming&&(zpan.zooming=!1,cJson.images[imageIx],l=getZoomPoint(),log(`i${imageIx+1}: touchend: c: (${two(zpan.current.cx)}, ${two(zpan.current.cy)}) `+`d: ${two(zpan.current.distance)}, scale: ${two(l.scale)}, `+`t: (${two(l.tx)}, ${two(l.ty)})`))}function logJson(){log(JSON.stringify(cJson,function(t,e){return["scale","tx","ty"].includes(t)?two(e):e},2))}function horizontalScrollMove(t){t.preventDefault(),hscroll.currentXTime=performance.now(),hscroll.currentX=t.touches[0].clientX,hscroll.currentScrollLeft=hscroll.startScrollLeft+hscroll.startX-hscroll.currentX,area.scrollLeft=hscroll.currentScrollLeft}function horizontalScrollEnd(){function t(){var t=hscroll.leftEdges.indexOf(area.scrollLeft);-1==t?logError(`area.scrollLeft ${area.scrollLeft} was not found.`):imageIx==t?log(`ScrollEnd: scrolled back to the original item ${imageIx+1}.`):(imageIx=t,log(`ScrollEnd: scroll done: area.scrollLeft: ${area.scrollLeft}, image: `+(imageIx+1))),hscroll.scrolling=!1}var e=hscroll.currentXTime-hscroll.startXTime,l=hscroll.currentX-hscroll.startX,e=Math.abs(l/e)>hscroll.minFlick;let a;a=e?(log("Flick the image."),0<l?-availWidth:availWidth):hscroll.currentScrollLeft>hscroll.startScrollLeft+availWidth/2?availWidth:hscroll.currentScrollLeft<hscroll.startScrollLeft-availWidth/2?-availWidth:0;var o,e=hscroll.currentScrollLeft,l=hscroll.startScrollLeft+a;area.scrollLeft==l?t():(o=availWidth/2,log(`ScrollEnd: animate from ${two(e)} to `+l),animatePosition(e,l,hscroll.framesPerSec,o,hscroll.maxDuration,t,t=>{area.scrollLeft=t}))}function animatePosition(t,e,l,a,o,n,r){var i=hscroll.maxDuration*hscroll.framesPerSec,i=Math.abs(e-t)*i/a;let s=0;const c=distanceList(t,e,i);a=i/hscroll.framesPerSec;const h=setInterval(function(){s>=c.length?(clearInterval(h),null!==n&&n()):(r(c[s]),s+=1)},a/1e3)}function distanceList(e,t,l){var a=[],o=t-e;if(1<l&&1<Math.abs(o)){var n=o/l;for(let t=1;t<l-1;t++)a.push(Math.round(e+n*t))}return a.push(t),a}function handleResize(){var t;null!==area&&((t=new Timer).log("resize"),setAvailableArea()&&(t.log("sizeImages"),sizeImages()),t.log("resize  done"))}